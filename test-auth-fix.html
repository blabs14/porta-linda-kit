<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de AutenticaÃ§Ã£o - CorreÃ§Ãµes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Teste de AutenticaÃ§Ã£o - VerificaÃ§Ã£o das CorreÃ§Ãµes</h1>
    
    <div>
        <button onclick="testAuth()">Testar Estado de AutenticaÃ§Ã£o</button>
        <button onclick="testLogin()">Testar Login</button>
        <button onclick="testLogout()">Testar Logout</button>
        <button onclick="clearLogs()">Limpar Logs</button>
    </div>
    
    <div id="logs"></div>
    
    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
        
        const supabaseUrl = 'https://ebitcwrrcumsvqjgrapw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImViaXRjd3JyY3Vtc3ZxamdyYXB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NjcyMTYsImV4cCI6MjA2ODM0MzIxNn0.hLlTeSD2VzVCjvUSXLYQypXNYqthDx0q1N86aOftfEY';
        
        const supabase = createClient(supabaseUrl, supabaseKey);
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
        }
        
        window.testAuth = async function() {
            try {
                log('ðŸ” Verificando estado de autenticaÃ§Ã£o...', 'info');
                
                // Verificar sessÃ£o atual
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    log(`âŒ Erro ao obter sessÃ£o: ${sessionError.message}`, 'error');
                    return;
                }
                
                if (session) {
                    log(`âœ… Utilizador autenticado: ${session.user.email}`, 'success');
                    log(`ðŸ”‘ Token vÃ¡lido atÃ©: ${new Date(session.expires_at * 1000).toLocaleString()}`, 'info');
                    log(`ðŸ“± Ãšltimo login: ${new Date(session.user.last_sign_in_at).toLocaleString()}`, 'info');
                } else {
                    log('âŒ Nenhum utilizador autenticado', 'error');
                }
                
                // Verificar localStorage
                const localStorageKeys = Object.keys(localStorage).filter(key => key.includes('supabase'));
                log(`ðŸ’¾ Chaves no localStorage: ${localStorageKeys.length}`, 'info');
                localStorageKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    log(`   - ${key}: ${value ? 'presente' : 'vazio'}`, 'info');
                });
                
            } catch (error) {
                log(`âŒ Erro inesperado: ${error.message}`, 'error');
            }
        }
        
        window.testLogin = async function() {
            try {
                log('ðŸ” Iniciando teste de login...', 'info');
                
                const email = 'test@example.com';
                const password = 'password123';
                
                log(`ðŸ“§ Tentando login com: ${email}`, 'info');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    log(`âŒ Erro no login: ${error.message}`, 'error');
                    
                    // Se o utilizador nÃ£o existe, tentar criar
                    if (error.message.includes('Invalid login credentials')) {
                        log('ðŸ‘¤ Utilizador nÃ£o existe, tentando criar...', 'info');
                        
                        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                            email: email,
                            password: password
                        });
                        
                        if (signUpError) {
                            log(`âŒ Erro ao criar utilizador: ${signUpError.message}`, 'error');
                        } else {
                            log(`âœ… Utilizador criado com sucesso: ${signUpData.user?.email}`, 'success');
                            if (signUpData.session) {
                                log(`ðŸŽ‰ Login automÃ¡tico apÃ³s registo bem-sucedido`, 'success');
                            } else {
                                log(`ðŸ“§ VerificaÃ§Ã£o de email necessÃ¡ria`, 'info');
                            }
                        }
                    }
                } else {
                    log(`âœ… Login bem-sucedido: ${data.user.email}`, 'success');
                    log(`ðŸ”‘ SessÃ£o criada: ${data.session ? 'Sim' : 'NÃ£o'}`, 'info');
                }
                
            } catch (error) {
                log(`âŒ Erro inesperado no login: ${error.message}`, 'error');
            }
        }
        
        window.testLogout = async function() {
            try {
                log('ðŸšª Iniciando logout...', 'info');
                
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    log(`âŒ Erro no logout: ${error.message}`, 'error');
                } else {
                    log(`âœ… Logout bem-sucedido`, 'success');
                }
                
                // Verificar se a sessÃ£o foi realmente removida
                setTimeout(async () => {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session) {
                        log(`âš ï¸ AtenÃ§Ã£o: SessÃ£o ainda presente apÃ³s logout!`, 'error');
                    } else {
                        log(`âœ… SessÃ£o removida com sucesso`, 'success');
                    }
                }, 100);
                
            } catch (error) {
                log(`âŒ Erro inesperado no logout: ${error.message}`, 'error');
            }
        }
        
        // Listener para mudanÃ§as de estado de autenticaÃ§Ã£o
        supabase.auth.onAuthStateChange((event, session) => {
            log(`ðŸ”„ MudanÃ§a de estado: ${event}`, 'info');
            if (session) {
                log(`ðŸ‘¤ SessÃ£o ativa: ${session.user.email}`, 'success');
            } else {
                log(`ðŸ‘¤ Nenhuma sessÃ£o ativa`, 'info');
            }
        });
        
        // Teste inicial
        log('ðŸš€ Sistema de teste carregado. Clique nos botÃµes para testar.', 'info');
        
    </script>
</body>
</html>